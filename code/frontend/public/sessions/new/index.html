
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>new - Session</title>
<link rel="stylesheet" href="/style.css">
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.0/build/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
<!-- Dark Mode Toggle -->
<div class="theme-toggle" onclick="toggleTheme()">
    <span class="theme-icon" id="themeIcon">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" fill="currentColor"/>
        </svg>
    </span>
    <span id="themeText">Dark</span>
</div>

<!-- Message Container -->
<div id="messageContainer"></div>

<!-- Refresh Button -->
<button class="refresh-button" onclick="updateTopics()" title="Refresh Topics">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M4 12C4 7.58172 7.58172 4 12 4C14.5264 4 16.7792 5.17108 18.2454 7M20 12C20 16.4183 16.4183 20 12 20C9.47362 20 7.22082 18.8289 5.75463 17" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <path d="M18 3V7H14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M6 21V17H10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
</button>

<!-- AI Summary Button -->
<button class="ai-summary-button" onclick="generateAISummary()" title="Generate AI Summary">
    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 2L13.5 8.5L20 10L13.5 11.5L12 18L10.5 11.5L4 10L10.5 8.5L12 2Z" fill="currentColor"/>
        <path d="M19 4L19.5 6.5L22 7L19.5 7.5L19 10L18.5 7.5L16 7L18.5 6.5L19 4Z" fill="currentColor"/>
        <path d="M19 14L19.5 16.5L22 17L19.5 17.5L19 20L18.5 17.5L16 17L18.5 16.5L19 14Z" fill="currentColor"/>
    </svg>
</button>

<div class="topics-page">
    <div class="page-header">
        <div class="header-content">
            <h1>new</h1>
            <p class="subtitle">View and contribute to topics</p>
        </div>
        <div class="user-counter" id="user-counter">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <circle cx="9" cy="7" r="4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M16 3.13a4 4 0 0 1 0 7.75" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span id="user-count">0</span>
        </div>
    </div>
    
    <div class="topics-grid" id="topics-grid"></div>
    
    <div class="empty-state" id="empty-state" style="display: none;">
        <div class="empty-state-icon">üìù</div>
        <p>No topics yet</p>
        <p style="font-size: 14px; margin-top: 8px;">Topics will appear here once they are created</p>
    </div>
</div>

<!-- Modal -->
<div class="modal-overlay" id="modal-overlay" onclick="closeModalOnOverlay(event)">
    <div class="modal" onclick="event.stopPropagation()" style="max-width: 1400px; width: 90vw;">
        <div class="modal-header">
            <h2 id="modal-title">Topic</h2>
            <div class="modal-nav">
                <button onclick="refreshModalContent()" title="Refresh topics">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M4 12C4 7.58172 7.58172 4 12 4C14.5264 4 16.7792 5.17108 18.2454 7M20 12C20 16.4183 16.4183 20 12 20C9.47362 20 7.22082 18.8289 5.75463 17" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <path d="M18 3V7H14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M6 21V17H10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <button onclick="navigateTopic(-1)" id="prev-btn">‚Üê</button>
                <button onclick="navigateTopic(1)" id="next-btn">‚Üí</button>
                <button class="modal-close" onclick="closeModal()">‚úï</button>
            </div>
        </div>
        <div class="modal-body" style="display: flex; gap: 30px; max-height: 75vh;">
            <div style="flex: 1; display: flex; flex-direction: column;">
                <div style="flex: 1; overflow-y: auto; padding-right: 15px; margin-bottom: 15px;">
                    <div class="subtopics-list" id="subtopics-list"></div>
                </div>
                <div class="input-container topic-input" id="topic-input-container" style="margin-top: auto;">
                    <input type="text" id="modal-input" placeholder="Add input to this topic..." />
                    <button onclick="sendInput()">Send</button>
                </div>
            </div>
            <div style="width: 500px; min-width: 500px; display: flex; flex-direction: column; padding: 30px; background: var(--card-background); border-radius: 12px; overflow-y: auto;">
                <h3 style="margin: 0 0 30px 0; color: var(--text-primary); font-size: 20px; font-weight: 600; text-align: center;">Topic Overview</h3>
                <div style="width: 100%; aspect-ratio: 1;">
                    <canvas id="topic-radar-chart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- AI Summary Modal -->
<div class="modal-overlay" id="ai-summary-modal" onclick="closeAISummaryModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h2>‚ú® AI Summary</h2>
            <button class="modal-close" onclick="closeAISummaryModal()">‚úï</button>
        </div>
        <div class="modal-body">
            <div id="ai-summary-content" style="white-space: pre-wrap; line-height: 1.8; font-size: 15px;"></div>
        </div>
    </div>
</div>

<!-- QR Code Modal -->
<div class="modal-overlay" id="qr-code-modal" onclick="closeQRCodeModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h2>QR Code</h2>
            <button class="modal-close" onclick="closeQRCodeModal()">‚úï</button>
        </div>
        <div class="modal-body">
            <div id="qr-code-container" style="display: flex; justify-content: center; align-items: center; padding: 20px;"></div>
            <p style="text-align: center; margin-top: 20px; color: var(--text-secondary);">Scan to open the session</p>
        </div>
    </div>
</div>

<script>
let topicsData = {};
let currentTopicIndex = 0;
let topicKeys = [];
let currentTopic = null;
let radarChart = null;

// Dark Mode
function toggleTheme() {
    const html = document.documentElement;
    const currentTheme = html.getAttribute('data-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    html.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    updateThemeIcon(newTheme);
}

function updateThemeIcon(theme) {
    const icon = document.getElementById('themeIcon');
    const text = document.getElementById('themeText');
    if (icon && text) {
        if (theme === 'dark') {
            // Sun icon for light mode
            icon.innerHTML = `
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="12" r="4" fill="currentColor"/>
                    <path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
            `;
            text.textContent = 'Light';
        } else {
            // Moon icon for dark mode
            icon.innerHTML = `
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" fill="currentColor"/>
                </svg>
            `;
            text.textContent = 'Dark';
        }
    }
}

document.addEventListener('DOMContentLoaded', () => {
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    updateThemeIcon(savedTheme);
});

// User tracking
const userId = 'user_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();

function sendHeartbeat() {
    fetch('/heartbeat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            sessionName: 'new',
            userId: userId
        })
    })
    .then(res => res.json())
    .then(data => {
        document.getElementById('user-count').textContent = data.count;
    })
    .catch(err => console.error('Heartbeat failed:', err));
}

// Send heartbeat immediately and then every 10 seconds
sendHeartbeat();
setInterval(sendHeartbeat, 10000);

// Update count when window gets focus
window.addEventListener('focus', sendHeartbeat);

function showMessage(text, type) {
    const container = document.getElementById('messageContainer');
    if (!container) return;
    const message = document.createElement('div');
    message.className = `message ${type}`;
    message.textContent = text;
    container.innerHTML = '';
    container.appendChild(message);
    setTimeout(() => {
        message.style.opacity = '0';
        setTimeout(() => {
            if (container.contains(message)) {
                container.removeChild(message);
            }
        }, 500);
    }, 3000);
}

function sendInput() {
    if (!currentTopic) return;
    const inputField = document.getElementById('modal-input');
    const input = inputField.value.trim();
    if (!input) {
        showMessage('Please enter some text', 'error');
        return;
    }

    fetch('http://localhost:8000/input', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            session_uid: 'new',
            topic_uid: currentTopic,
            text: input
        })
    })
    .then(res => {
        if (!res.ok) throw new Error('Failed to send input');
        inputField.value = '';
        showMessage('Input sent successfully!', 'success');
    })
    .catch(err => {
        console.error(err);
        showMessage('Failed to send input', 'error');
    });
}

function updateTopics() {
    fetch('/sessions/new/topics.json')
        .then(res => res.json())
        .then(data => {
            topicsData = data.topics || {};
            topicKeys = Object.keys(topicsData);
            renderTopicsGrid();
        })
        .catch(err => console.error(err));
}

function renderTopicsGrid() {
    const grid = document.getElementById('topics-grid');
    const emptyState = document.getElementById('empty-state');
    
    if (topicKeys.length === 0) {
        grid.style.display = 'none';
        emptyState.style.display = 'block';
        return;
    }
    
    grid.style.display = 'grid';
    emptyState.style.display = 'none';
    grid.innerHTML = '';
    
    topicKeys.forEach((topic, index) => {
        const subtopics = topicsData[topic];
        const subtopicCount = Object.keys(subtopics || {}).length;
        
        const card = document.createElement('div');
        card.className = 'topic-card';
        card.onclick = () => openModal(index);
        
        card.innerHTML = `
            <h2>${topic}</h2>
            <p class="subtopic-count">${subtopicCount} subtopic${subtopicCount !== 1 ? 's' : ''}</p>
        `;
        
        grid.appendChild(card);
    });
}

function openModal(index) {
    currentTopicIndex = index;
    currentTopic = topicKeys[index];
    const subtopics = topicsData[currentTopic];
    
    document.getElementById('modal-title').textContent = currentTopic;
    
    const subtopicsList = document.getElementById('subtopics-list');
    subtopicsList.innerHTML = '';
    
    if (!subtopics || Object.keys(subtopics).length === 0) {
        subtopicsList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>No subtopics yet</p></div>';
    } else {
        // Sortiere Subtopics nach Anzahl der Inputs (absteigend - mehr Inputs = weiter oben)
        const sortedSubtopics = Object.entries(subtopics).sort((a, b) => b[1].length - a[1].length);
        
        for (const [subtopic, inputs] of sortedSubtopics) {
            const subtopicItem = document.createElement('div');
            subtopicItem.className = 'subtopic-item';
            
            const header = document.createElement('div');
            header.className = 'subtopic-header';
            header.onclick = () => toggleSubtopic(subtopicItem);
            
            const title = document.createElement('h3');
            title.textContent = subtopic;
            
            const toggle = document.createElement('div');
            toggle.className = 'subtopic-toggle';
            toggle.textContent = '‚ñº';
            
            header.appendChild(title);
            header.appendChild(toggle);
            
            const content = document.createElement('div');
            content.className = 'subtopic-content';
            
            const inputsDiv = document.createElement('div');
            inputsDiv.className = 'subtopic-inputs';
            
            const ul = document.createElement('ul');
            ul.className = 'input-list';
            
            inputs.forEach(input => {
                const li = document.createElement('li');
                li.className = 'input-item';
                li.textContent = input;
                ul.appendChild(li);
            });
            
            inputsDiv.appendChild(ul);
            content.appendChild(inputsDiv);
            
            subtopicItem.appendChild(header);
            subtopicItem.appendChild(content);
            subtopicsList.appendChild(subtopicItem);
        }
    }
    
    updateNavigationButtons();
    updateRadarChart(subtopics);
    document.getElementById('modal-overlay').classList.add('active');
    document.body.style.overflow = 'hidden';
}

function toggleSubtopic(element) {
    element.classList.toggle('active');
}

function closeModal() {
    document.getElementById('modal-overlay').classList.remove('active');
    document.body.style.overflow = '';
    currentTopic = null;
}

function closeModalOnOverlay(event) {
    if (event.target.id === 'modal-overlay') {
        closeModal();
    }
}

function navigateTopic(direction) {
    currentTopicIndex += direction;
    if (currentTopicIndex < 0) currentTopicIndex = topicKeys.length - 1;
    if (currentTopicIndex >= topicKeys.length) currentTopicIndex = 0;
    openModal(currentTopicIndex);
}

function updateNavigationButtons() {
    document.getElementById('prev-btn').disabled = topicKeys.length <= 1;
    document.getElementById('next-btn').disabled = topicKeys.length <= 1;
}

// Keyboard navigation
document.addEventListener('keydown', (e) => {
    const modal = document.getElementById('modal-overlay');
    if (!modal.classList.contains('active')) return;
    
    if (e.key === 'Escape') {
        closeModal();
    } else if (e.key === 'ArrowLeft') {
        navigateTopic(-1);
    } else if (e.key === 'ArrowRight') {
        navigateTopic(1);
    }
});

// Refresh Modal Function
function refreshModal() {
    if (currentTopic) {
        fetch('/getTopics/new')
            .then(res => res.json())
            .then(data => {
                topicsData = data;
                topicKeys = Object.keys(topicsData);
                openModal(currentTopicIndex);
                showMessage('Topics refreshed', 'success');
            })
            .catch(err => {
                console.error(err);
                showMessage('Failed to refresh topics', 'error');
            });
    }
}

// AI Summary Modal Functions
function closeAISummaryModal(event) {
    if (event && event.target.id !== 'ai-summary-modal') return;
    const modal = document.getElementById('ai-summary-modal');
    modal.classList.remove('active');
}

// AI Summary Function
async function generateAISummary() {
    if (Object.keys(topicsData).length === 0) {
        showMessage('No topics to summarize', 'error');
        return;
    }
    
    showMessage('Generating AI summary...', 'success');
    
    try {
        const response = await fetch('/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                message: JSON.stringify(topicsData, null, 2)
            })
        });
        
        if (!response.ok) throw new Error('Failed to generate summary');
        
        const data = await response.json();
        
        // Display summary in modal
        const summaryContent = document.getElementById('ai-summary-content');
        summaryContent.textContent = data.response;
        
        const modal = document.getElementById('ai-summary-modal');
        modal.classList.add('active');
        
        showMessage('Summary generated successfully!', 'success');
    } catch (err) {
        console.error(err);
        showMessage('Failed to generate summary', 'error');
    }
}

// Refresh Modal Content Function - reloads topics and reopens modal
function refreshModalContent() {
    fetch('/sessions/new/topics.json')
        .then(res => res.json())
        .then(data => {
            topicsData = data.topics || {};
            topicKeys = Object.keys(topicsData);
            renderTopicsGrid();
            // Re-open the current modal with refreshed data
            if (currentTopic) {
                openModal(currentTopicIndex);
            }
            showMessage('Topics refreshed', 'success');
        })
        .catch(err => {
            console.error(err);
            showMessage('Failed to refresh topics', 'error');
        });
}

// Radar Chart Update Function
function updateRadarChart(subtopics) {
    const canvas = document.getElementById('topic-radar-chart');
    if (!canvas) return;
    
    // Destroy existing chart if it exists
    if (radarChart) {
        radarChart.destroy();
    }
    
    // If no subtopics, show empty state
    if (!subtopics || Object.keys(subtopics).length === 0) {
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        return;
    }
    
    // Prepare data for radar chart
    const labels = [];
    const dataValues = [];
    
    // Find max input count for chart scale
    let maxInputs = 0;
    Object.values(subtopics).forEach(inputs => {
        if (inputs.length > maxInputs) {
            maxInputs = inputs.length;
        }
    });
    
    // Build labels and data - use actual counts
    Object.entries(subtopics).forEach(([subtopic, inputs]) => {
        labels.push(subtopic);
        dataValues.push(inputs.length);
    });
    
    // Get current theme colors
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    const primaryColor = isDark ? 'rgb(96, 165, 250)' : 'rgb(59, 130, 246)';
    const backgroundColor = isDark ? 'rgba(96, 165, 250, 0.2)' : 'rgba(59, 130, 246, 0.2)';
    const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
    const textColor = isDark ? 'rgba(255, 255, 255, 0.9)' : 'rgba(0, 0, 0, 0.9)';
    
    // Calculate appropriate step size based on max value
    const stepSize = Math.ceil(maxInputs / 5);
    const chartMax = Math.ceil(maxInputs / stepSize) * stepSize || 5;
    
    // Create radar chart
    const ctx = canvas.getContext('2d');
    radarChart = new Chart(ctx, {
        type: 'radar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Input Count',
                data: dataValues,
                fill: true,
                backgroundColor: backgroundColor,
                borderColor: primaryColor,
                pointBackgroundColor: primaryColor,
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: primaryColor,
                borderWidth: 3,
                pointRadius: 5,
                pointHoverRadius: 7
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                r: {
                    beginAtZero: true,
                    max: chartMax,
                    ticks: {
                        display: false,
                        stepSize: stepSize,
                        color: textColor,
                        backdropColor: 'transparent',
                        font: {
                            size: 14
                        }
                    },
                    grid: {
                        color: gridColor
                    },
                    pointLabels: {
                        color: textColor,
                        font: {
                            size: 16,
                            weight: '500'
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: isDark ? 'rgba(30, 30, 30, 0.95)' : 'rgba(255, 255, 255, 0.95)',
                    titleColor: textColor,
                    bodyColor: textColor,
                    borderColor: primaryColor,
                    borderWidth: 1,
                    padding: 12,
                    bodyFont: {
                        size: 15
                    },
                    titleFont: {
                        size: 16,
                        weight: 'bold'
                    },
                    callbacks: {
                        label: function(context) {
                            const count = context.parsed.r;
                            return `${count} input${count !== 1 ? 's' : ''}`;
                        }
                    }
                }
            }
        }
    });
}

// QR Code functions
function showQRCode() {
    const container = document.getElementById('qr-code-container');
    container.innerHTML = ''; // Clear previous QR code
    
    // Get the current URL without /admin
    const currentUrl = window.location.href.replace('/admin', '');
    
    // Generate QR code
    QRCode.toCanvas(container, currentUrl, {
        width: 256,
        margin: 2,
        color: {
            dark: getComputedStyle(document.documentElement).getPropertyValue('--text-primary').trim(),
            light: getComputedStyle(document.documentElement).getPropertyValue('--background').trim()
        }
    }, function (error) {
        if (error) {
            console.error(error);
            showMessage('Failed to generate QR code', 'error');
            return;
        }
        document.getElementById('qr-code-modal').classList.add('active');
        document.body.style.overflow = 'hidden';
    });
}

function closeQRCodeModal(event) {
    if (event && event.target.id !== 'qr-code-modal') return;
    document.getElementById('qr-code-modal').classList.remove('active');
    document.body.style.overflow = '';
}

// Add keyboard support for modals
document.addEventListener('keydown', (e) => {
    const aiModal = document.getElementById('ai-summary-modal');
    const qrModal = document.getElementById('qr-code-modal');
    
    if (aiModal.classList.contains('active') && e.key === 'Escape') {
        closeAISummaryModal();
    } else if (qrModal.classList.contains('active') && e.key === 'Escape') {
        closeQRCodeModal();
    }
});

// Initialize topics on page load
updateTopics();
</script>
</body>
</html>